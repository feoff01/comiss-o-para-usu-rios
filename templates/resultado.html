<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Comiss√µes | Resultado</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
   :root {
  --fundo: #0F0F10;
  --fundo-card: #1A1A1C;
  --fundo-card-2: #232326;

  --gold: #C9A86A;
  --gold-light: #E7D3A5;
  --gold-dark: #B48A55;

  --texto-primario: #F2F2F2;
  --texto-secundario: #B5B5B5;

  --borda-fraca: rgba(200, 200, 200, 0.08);
}

body {
  background: #f5f7fb;
  font-size: 0.95rem;
}

@media (min-width: 1200px) {
  .container { max-width: 1400px; }
}

.card {
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
}

.card .fs-4.fw-bold {
  font-size: 1.6rem !important;
}

table {
  font-size: 0.95rem;
}

.btn-voltar-fixo {
  position: fixed;
  top: 12px;
  left: 12px;
  z-index: 3000;
}

th { white-space: nowrap; }

/* =========================================================
   ABA √ÅRVORE - TABELA DETALHADA (SEM STICKY / SEM LARGURA FIXA)
   ========================================================= */
#tabela-arvore-wrapper {
  max-height: 260px;
  overflow-x: auto;
  overflow-y: auto;
  position: relative;
}

#tabela-arvore-wrapper table {
  table-layout: auto;
  width: max-content;
  border-collapse: separate;
  border-spacing: 0;
}

#tabela-arvore-wrapper th,
#tabela-arvore-wrapper td {
  white-space: nowrap;
  overflow: visible;
  text-overflow: clip;
  max-width: none !important;
  min-width: 0 !important;
}

/* Bot√µes dourados fixos na cor #f3cb04 */
.btn-success {
  background-color: #f3cb04 !important;
  border-color: #e0b703 !important;
  color: #3a2f1c !important;
  font-weight: 600;
  border-radius: 6px;
  box-shadow: 0 3px 8px rgba(243, 203, 4, 0.35);
}
.btn-success:hover {
  background-color: #d9b404 !important;
  border-color: #c09f03 !important;
  color: #3a2f1c !important;
  box-shadow: 0 4px 12px rgba(243, 203, 4, 0.45);
}

/* Bot√µes outline dourados */
.btn-outline-success {
  background-color: #f3cb04 !important;
  color: #3a2f1c !important;
  border-color: #e0b703 !important;
  font-weight: 600;
}
.btn-outline-success:hover {
  background-color: #d9b404 !important;
  border-color: #c09f03 !important;
  color: #3a2f1c !important;
}

/* =========================================================
   ESTILO DA √ÅRVORE (CLARO + ESCADINHA)
   ========================================================= */

#pane-arvore .card {
  background: #ffffff;
  color: #111827;
  border-radius: 18px;
  border: 1px solid #e5e7eb;
}

#pane-arvore h2,
#pane-arvore h6 {
  color: #111827;
}

#pane-arvore p,
#pane-arvore label,
#pane-arvore small,
#pane-arvore .text-muted {
  color: #6b7280 !important;
}

.tree-wrapper {
  margin-top: 20px;
  overflow-x: auto;
  padding: 16px 0 8px 0;
  text-align: center;
}

.tree {
  display: inline-block;
  text-align: center;
  font-size: 0.85rem;
}

.tree > div {
  position: relative;
  padding-bottom: 10px;
}

#btn-arvore { display: none !important; }

.tree-level {
  display: flex;
  justify-content: flex-start;
  gap: 40px;
  margin-top: 26px;
  position: relative;
}

.tree > div > .tree-level:nth-child(1) {
  margin-left: 0;
  justify-content: center;
}
.tree > div > .tree-level:nth-child(2) { margin-left: 80px; }
.tree > div > .tree-level:nth-child(3) { margin-left: 160px; }
.tree > div > .tree-level:nth-child(4) { margin-left: 240px; }

.tree-level::before {
  content: "";
  position: absolute;
  top: -18px;
  left: -40px;
  width: 40px;
  height: 1px;
  background: rgba(148, 163, 184, 0.6);
}

.tree-connector { position: relative; }

.tree-connector::before {
  content: "";
  position: absolute;
  top: -18px;
  left: 50%;
  transform: translateX(-50%);
  width: 1px;
  height: 18px;
  background: rgba(148, 163, 184, 0.6);
}

.tree-node {
  min-width: 230px;
  background: linear-gradient(135deg, #f9fafb 0%, #ffffff 60%, #eef2ff 100%);
  border-radius: 16px;
  padding: 12px 14px 10px 14px;
  border: 1px solid rgba(148, 163, 184, 0.7);
  box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
  position: relative;
}

.tree-label {
  font-size: 0.7rem;
  font-weight: 600;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #6b7280;
  margin-bottom: 4px;
}

.tree-value {
  font-size: 1.1rem;
  font-weight: 700;
  color: #111827;
}

.tree-pill {
  position: absolute;
  top: -11px;
  left: 12px;
  padding: 2px 10px;
  border-radius: 999px;
  font-size: 0.7rem;
  font-weight: 600;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  border: 1px solid rgba(148, 163, 184, 0.9);
}

.node-produto .tree-pill { background: #facc15; color: #1f2937; }
.node-xp .tree-pill { background: #38bdf8; color: #0f172a; }
.node-escritorio-bruto .tree-pill { background: #a855f7; color: #f9fafb; }
.node-imposto .tree-pill { background: #f97373; color: #111827; }
.node-escritorio-pos .tree-pill { background: #22c55e; color: #022c22; }
.node-assessor .tree-pill { background: #4ade80; color: #052e16; }
.node-sobra .tree-pill { background: #94a3b8; color: #020617; }

.arvore-resumo-top {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
}

.arvore-resumo-pill {
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 0.75rem;
  background: #f9fafb;
  border: 1px solid rgba(148, 163, 184, 0.8);
  color: #111827;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.arvore-resumo-pill span.label {
  text-transform: uppercase;
  letter-spacing: 0.07em;
  font-weight: 600;
  font-size: 0.68rem;
  color: #6b7280;
}

.resumo-produto-card {
  border-radius: 16px;
  border: 1px solid #e5e7eb;
  padding: 12px 14px;
  background: #ffffff;
  box-shadow: 0 10px 25px rgba(15,23,42,0.08);
  height: 100%;
  color: #111827;
}

.resumo-produto-card .titulo-produto {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 6px;
  color: #111827;
}

.resumo-produto-card small {
  font-size: 0.7rem;
  color: #6b7280;
  text-transform: uppercase;
}

.tree-sublist {
  margin-top: 8px;
  border-top: 1px dashed rgba(148, 163, 184, 0.7);
  padding-top: 6px;
  text-align: left;
  font-size: 0.75rem;
  max-height: 120px;
  overflow-y: auto;
}

.tree-prod-linha {
  display: flex;
  justify-content: space-between;
  gap: 8px;
  margin-bottom: 2px;
}

.tree-prod-linha span.prod-nome {
  font-weight: 500;
  color: #374151;
}
.tree-prod-linha span.prod-valor {
  font-variant-numeric: tabular-nums;
  color: #111827;
}

/* AMARELO SUAVE PARA "Pago ao assessor" */
.node-assessor.tree-node {
  background: linear-gradient(145deg, #fffdf6 0%, #fff9e5 45%, #fff4cc 100%) !important;
  color: #4a493f !important;
  border: 1px solid #e8ddb0 !important;
  box-shadow: 0 2px 8px rgba(220, 200, 120, 0.18) !important;
  transform: scale(1.01);
}

.node-assessor .tree-label {
  color: #756c52 !important;
  font-size: 0.82rem;
  font-weight: 600;
}

.node-assessor .tree-value {
  color: #3a3320 !important;
  font-size: 1.30rem !important;
  font-weight: 700 !important;
  text-shadow: 0 0 4px rgba(255, 240, 150, 0.6);
}

.node-assessor .tree-pill {
  background: #fff4cc !important;
  color: #4f4328 !important;
  border-color: #e8ddb0 !important;
  font-weight: 600;
}

/* ===== Overlay de carregamento ===== */
#loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.75);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  backdrop-filter: blur(2px);
}
.loading-card {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.12);
  padding: 18px 22px;
  display: flex;
  align-items: center;
  gap: 12px;
  border: 1px solid rgba(0,0,0,0.06);
}
.loading-text {
  font-weight: 600;
  color: #222;
}
  </style>
</head>

<body>
  <!-- Overlay -->
  <div id="loading-overlay">
    <div class="loading-card">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <div class="loading-text">Carregando...</div>
    </div>
  </div>

  <div class="container py-5">

    {% if competencia %}
      <div class="alert alert-info py-2 mb-3">
        <strong>Per√≠odo:</strong> {{ competencia }}
      </div>
    {% endif %}

    <!-- ===================== TROCAR ARQUIVO (SUPABASE) ===================== -->
<div class="card p-3 mb-3" id="trocar-arquivo">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
    <div>
      <div class="fw-semibold">Trocar arquivo exibido</div>
      <div class="text-muted small">
        Selecione o Per√≠odo e a vers√£o do df_final para recarregar este dashboard.
      </div>
    </div>

    <form action="/visualizar" method="get" class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label small mb-1">Per√≠odo</label>
        <select id="competencia-select-res" name="competencia" class="form-select form-select-sm">
          <option value="">‚Äî Selecione ‚Äî</option>
          {% for c in competencias_disponiveis %}
            <option value="{{ c }}" {% if c == competencia_atual %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-auto">
        <label class="form-label small mb-1">Arquivo (vers√£o)</label>

        <!-- envia o path real -->
        <input type="hidden" id="arquivo-hidden-res" name="file" value="{{ caminho_df_final or '' }}"/>

        <!-- s√≥ mostra ao usu√°rio -->
        <input
          type="text"
          id="arquivo-label-res"
          class="form-control form-control-sm"
          value="{% if caminho_df_final %}{{ caminho_df_final.split('/')[-1] }}{% else %}Selecione um Per√≠odo{% endif %}"
          disabled
          style="min-width: 220px;"
        />
      </div>

      <div class="col-auto">
        <button type="submit" class="btn btn-outline-dark btn-sm">
          Aplicar
        </button>
      </div>
    </form>
  </div>
</div>


    <div class="row mb-3">
      <div class="col-12 d-flex justify-content-between align-items-center">
        <h1 class="h4 m-0">√Årvore de comiss√£o</h1>
        <div>
          <a href="/" class="btn btn-outline-secondary btn-sm btn-voltar-fixo">Voltar</a>
        </div>
      </div>
    </div>

    <!-- √öNICO CONTE√öDO: √ÅRVORE -->
    <div id="pane-arvore">
      <div class="card p-3 mb-3">
        <h2 class="h6 mb-3">√Årvore de recebimento de comiss√£o</h2>
        <p class="text-muted small mb-3">
          Visualiza√ß√£o do caminho do dinheiro:
          <strong>Produto</strong> ‚Üí <strong>XP</strong> ‚Üí <strong>Escrit√≥rio (bruto)</strong> ‚Üí
          <strong>Imposto</strong> ‚Üí <strong>Escrit√≥rio p√≥s imposto</strong> ‚Üí
          <strong>Assessor</strong> ‚Üí <strong>Sobra Escrit√≥rio</strong>.
        </p>

        <div class="row g-3 align-items-end mb-3">

          <!-- Assessor -->
           <div class="col-md-4" style="display:none">

            <label class="form-label small fw-semibold">Assessor</label>
            <div class="input-group input-group-sm position-relative w-100">
              <span class="input-group-text">Assessor</span>
              <input
                type="text"
                id="assessor-arvore"
                class="form-control"
                placeholder="Digite para filtrar"
                autocomplete="off"
              />
              <button
                type="button"
                class="btn btn-outline-secondary"
                id="btn-limpar-assessor-arvore"
              >‚úï</button>

              <div
                id="sugestoes-assessor-arvore"
                class="list-group position-absolute w-100"
                style="top:100%;left:0;max-height:200px;overflow-y:auto;display:none;z-index:1000;"
              ></div>
            </div>
          </div>

          <!-- Categoria -->
          <div class="col-md-4">
            <label class="form-label small fw-semibold">Categoria</label>
            <div class="input-group input-group-sm position-relative w-100">
              <span class="input-group-text">Categoria</span>
              <input
                type="text"
                id="produto-arvore"
                class="form-control"
                placeholder="Digite para filtrar"
                autocomplete="off"
              />
              <button
                type="button"
                class="btn btn-outline-secondary"
                id="btn-limpar-categoria-arvore"
              >‚úï</button>

              <div
                id="sugestoes-produto-arvore"
                class="list-group position-absolute w-100"
                style="top:100%;left:0;max-height:200px;overflow-y:auto;display:none;z-index:1000;"
              ></div>
            </div>
          </div>

          <!-- Bot√£o (mantido, mas fica escondido pelo CSS #btn-arvore {display:none}) -->
          <div class="col-md-4 text-md-end">
            <button id="btn-arvore" class="btn btn-primary btn-sm mt-3 mt-md-0">
              Atualizar √°rvore
            </button>
          </div>
        </div>

        <div class="mb-2 small">
          <span id="texto-filtro-arvore" class="text-muted"></span>
        </div>

        <h6 class="mt-3">
          <button
            class="btn btn-sm btn-outline-success rounded-pill d-inline-flex align-items-center gap-1 btn-resumo-categoria"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#resumo-categoria-collapse"
            aria-expanded="false"
            aria-controls="resumo-categoria-collapse"
          >
            <span class="me-1">Resumo por categoria</span>
            <span id="icone-resumo-categoria" class="small">‚ñ∏</span>
          </button>
        </h6>

        <div class="collapse" id="resumo-categoria-collapse">
          <div class="row g-3" id="resumo-produtos"></div>
        </div>

        <hr class="my-4">

        <h6>√Årvore do fluxo de comiss√£o</h6>
        <div id="arvore-container" class="tree-wrapper"></div>

       <div class="mt-4">
        <div class="row g-3">
          <div class="col-lg-6">
            <h6>Comiss√£o por categoria</h6>
            <div class="card p-3">
              <canvas id="chart-categoria" height="180"></canvas>
            </div>
          </div>

          <div class="col-lg-6">
            <h6>Comiss√£o por produto</h6>
            <div class="card p-3">
              <canvas id="chart-produto" height="180"></canvas>
            </div>
          </div>
        </div>
      </div>


        <hr class="my-4">

        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Tabela detalhada</h6>
          <button
            id="btn-exportar-tabela-arvore"
            class="btn btn-sm btn-outline-success"
            type="button"
          >
            Baixar tabela detalhada (CSV)
          </button>
        </div>

        <div id="tabela-arvore-wrapper" class="table-responsive mt-2"></div>

        <hr class="my-4">

        <h6>Tabela descritiva (Assessor ‚Üí Categoria ‚Üí Produto ‚Üí Opera√ß√µes)</h6>
        <div id="tabela-hierarquica-wrapper"></div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

 <script>
  const compSelRes = document.getElementById("competencia-select-res");
  const arqHiddenRes = document.getElementById("arquivo-hidden-res");
  const arqLabelRes  = document.getElementById("arquivo-label-res");

  async function carregarUltimoArquivoResultado(comp) {
    arqHiddenRes.value = "";
    arqLabelRes.value = "Carregando...";

    if (!comp) {
      arqLabelRes.value = "Selecione um Per√≠odo";
      return;
    }

    try {
      const res = await fetch(`/api/arquivos?competencia=${encodeURIComponent(comp)}`);
      const data = await res.json();

      if (!data.ok || !data.files || !data.files.length) {
        arqLabelRes.value = "Nenhum df_final encontrado";
        return;
      }

      // üîë SEMPRE pega o mais recente
      const latestPath = data.files[0];
      arqHiddenRes.value = latestPath;
      arqLabelRes.value = latestPath.split("/").pop();

    } catch (e) {
      arqLabelRes.value = "Erro ao listar arquivos";
    }
  }

  compSelRes?.addEventListener("change", (e) => {
    carregarUltimoArquivoResultado(e.target.value);
  });

  // quando a p√°gina j√° abre com m√™s selecionado
  (function initTrocaResultado() {
    const compAtual = compSelRes?.value;
    if (compAtual) carregarUltimoArquivoResultado(compAtual);
  })();
</script>



  <script>
    // df_juntar vindo do Python
    const dfJuntar = {{ df_juntar | tojson | safe }};
    let chartCategoria = null;
    let chartProduto = null;


    const COLUNAS_ORDENADAS = [
      "C√≥digo Assessor",
      "Categoria",
      "Produto",
      "C√≥digo Cliente",
      "Receita Bruta",
      "Receita L√≠quida",
      "Comiss√£o (%) Escrit√≥rio",
      "Desconto de Transfer√™ncia de Clientes Fracionado",
      "Comiss√£o Escrit√≥rio",
      "Imposto + Despesa",
      "Valor Imposto",
      "Sem Imposto",
      "percentual",
      "Valor Assessor",
      "Valor Escrit√≥rio"
    ];

    let dadosArvoreAtual = [];

    function formatBRL(v) {
      if (!v) v = 0;
      return "R$ " + Number(v).toFixed(2)
        .replace('.', ',')
        .replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    function getUnicos(col) {
      const set = new Set();
      dfJuntar.forEach(row => {
        if (row[col] !== undefined && row[col] !== null && row[col] !== "") {
          set.add(row[col]);
        }
      });
      return Array.from(set).sort();
    }

    let listaAssessoresArvore = [];
    let listaCategoriasArvore = [];

    function carregarListasArvore() {
      listaAssessoresArvore = getUnicos("C√≥digo Assessor");
      listaCategoriasArvore = getUnicos("Categoria");
    }

    function atualizarURLComFiltroArvore() {
  const inputAss = document.getElementById("assessor-arvore");
  if (!inputAss) return;

  const valorCompleto = inputAss.value.trim();
  const url = new URL(window.location.href);

  if (valorCompleto) {
    // üîë pega s√≥ o c√≥digo antes do " - "
    const codigo = valorCompleto.split(" - ")[0].trim();
    url.searchParams.set("cod", codigo);
  } else {
    url.searchParams.set("cod", "FeFePaFaHi");
  }

  history.replaceState(null, "", url.toString());
}


    function mostrarSugestoesGeneric(inputEl, containerEl, listaValores) {
      const termo = (inputEl.value || "").toLowerCase().trim();
      containerEl.innerHTML = "";

      let filtrada;
      if (!termo) filtrada = listaValores;
      else filtrada = listaValores.filter(v => v.toString().toLowerCase().includes(termo));

      if (!filtrada.length) {
        containerEl.style.display = "none";
        return;
      }

      filtrada.slice(0, 50).forEach(v => {
        const item = document.createElement("button");
        item.type = "button";
        item.className = "list-group-item list-group-item-action py-1 px-2";
        item.textContent = v;

        item.addEventListener("click", () => {
          inputEl.value = v;
          containerEl.style.display = "none";

          if (inputEl.id === "assessor-arvore") {
            atualizarCategoriasPorAssessorAtual(); // üîë AQUI
            atualizarURLComFiltroArvore();
          }

          atualizarArvore();
          montarResumoProdutos();
        });

        containerEl.appendChild(item);
      });

      containerEl.style.display = "block";
    }

    function extrairCodigoAssessor(valor) {
  return (valor || "").toString().split(" - ")[0].trim();
}

function getCategoriasPorAssessor(codAssessor) {
  const cod = extrairCodigoAssessor(codAssessor).toLowerCase();
  const set = new Set();

  dfJuntar.forEach(row => {
    const codLinha = extrairCodigoAssessor(row["C√≥digo Assessor"]).toLowerCase();
    if (cod && codLinha !== cod) return;

    const cat = row["Categoria"];
    if (cat) set.add(cat);
  });

  return Array.from(set).sort();
}



    function configurarAutocompleteArvore() {
      const inputAss = document.getElementById("assessor-arvore");
      const boxAss = document.getElementById("sugestoes-assessor-arvore");
      const inputCat = document.getElementById("produto-arvore");
      const boxCat = document.getElementById("sugestoes-produto-arvore");

      if (!inputAss || !boxAss || !inputCat || !boxCat) return;

      inputAss.addEventListener("input", () => {
        mostrarSugestoesGeneric(inputAss, boxAss, listaAssessoresArvore);

        atualizarCategoriasPorAssessorAtual(); // üîë AQUI

        atualizarArvore();
        montarResumoProdutos();
        atualizarURLComFiltroArvore();
      });


      inputAss.addEventListener("focus", () => {
        mostrarSugestoesGeneric(inputAss, boxAss, listaAssessoresArvore);
      });

      inputCat.addEventListener("input", () => {
        mostrarSugestoesGeneric(inputCat, boxCat, listaCategoriasArvore);
        atualizarArvore();
      });

      inputCat.addEventListener("focus", () => {
        mostrarSugestoesGeneric(inputCat, boxCat, listaCategoriasArvore);
      });

      document.addEventListener("click", (e) => {
        if (!boxAss.contains(e.target) && e.target !== inputAss) boxAss.style.display = "none";
        if (!boxCat.contains(e.target) && e.target !== inputCat) boxCat.style.display = "none";
      });
    }

    function montarGraficoCategoria(dadosFiltrados) {
      const canvas = document.getElementById("chart-categoria");
      if (!canvas) return;

      if (!dadosFiltrados || !dadosFiltrados.length) {
        if (chartCategoria) { chartCategoria.destroy(); chartCategoria = null; }
        return;
      }

      const mapa = {};
      dadosFiltrados.forEach(l => {
        const cat = l["Categoria"] || "Sem categoria";
        const valor = Number(l["Valor Assessor"] || 0);
        if (!mapa[cat]) mapa[cat] = 0;
        mapa[cat] += valor;
      });

      const entriesOrdenadas = Object.entries(mapa).sort((a, b) => b[1] - a[1]);
      const TOP_N = 10;
      const topEntries = entriesOrdenadas.slice(0, TOP_N);

      const labels = topEntries.map(e => e[0]);
      const valores = topEntries.map(e => e[1]);

      if (chartCategoria) chartCategoria.destroy();

      const ctx = canvas.getContext("2d");
      chartCategoria = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Comiss√£o por categoria (R$)",
            data: valores,
            backgroundColor: "#f3cb04",
            hoverBackgroundColor: "#d9b404",
            borderColor: "#c9ae03",
            borderWidth: 1.2,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          indexAxis: "y",
          layout: { padding: 10 },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const valor = context.raw || 0;
                  return " " + formatBRL(valor);
                },
                title: function(context) { return context[0].label || ""; }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { callback: function(value) { return formatBRL(value); } },
              grid: { drawBorder: false, color: "rgba(148,163,184,0.25)" }
            },
            y: { grid: { display: false } }
          },
          elements: { bar: { borderRadius: 3, barThickness: 14, maxBarThickness: 18 } }
        }
      });
    }

    function filtrarDadosArvore(codAss, categoria) {
      const cod = (codAss || "").toString().toLowerCase().trim();
      const cat = (categoria || "").toString().toLowerCase().trim();

      return dfJuntar.filter(l => {
        const codLinha = (l["C√≥digo Assessor"] || "").toString().toLowerCase();
        const catLinha = (l["Categoria"] || "").toString().toLowerCase();

        const okAss = !cod || codLinha.includes(cod);
        const okCat = !cat || catLinha.includes(cat);

        return okAss && okCat;
      });
    }

    function montarGraficoProduto(dadosFiltrados) {
  const canvas = document.getElementById("chart-produto");
  if (!canvas) return;

  if (!dadosFiltrados || !dadosFiltrados.length) {
    if (chartProduto) { chartProduto.destroy(); chartProduto = null; }
    return;
  }

  const mapa = {};
  dadosFiltrados.forEach(l => {
    let prod = l["Produto"];

    // trata vazio/nan
    if (prod === null || prod === undefined) prod = "";
    prod = String(prod).trim();
    if (!prod || prod.toLowerCase() === "nan") prod = "Sem produto";

    const valor = Number(l["Valor Assessor"] || 0);
    if (!mapa[prod]) mapa[prod] = 0;
    mapa[prod] += valor;
  });

  const entriesOrdenadas = Object.entries(mapa).sort((a, b) => b[1] - a[1]);

  const TOP_N = 10;
  const topEntries = entriesOrdenadas.slice(0, TOP_N);

  const labels = topEntries.map(e => e[0]);
  const valores = topEntries.map(e => e[1]);

  if (chartProduto) chartProduto.destroy();

  const ctx = canvas.getContext("2d");
  chartProduto = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Comiss√£o por produto (R$)",
        data: valores,
        backgroundColor: "#f3cb04",
        hoverBackgroundColor: "#d9b404",
        borderColor: "#c9ae03",
        borderWidth: 1.2,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      indexAxis: "y",
      layout: { padding: 10 },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              const valor = context.raw || 0;
              return " " + formatBRL(valor);
            },
            title: function(context) { return context[0].label || ""; }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: { callback: function(value) { return formatBRL(value); } },
          grid: { drawBorder: false, color: "rgba(148,163,184,0.25)" }
        },
        y: { grid: { display: false } }
      },
      elements: { bar: { borderRadius: 3, barThickness: 14, maxBarThickness: 18 } }
    }
  });
}


    function montarResumoProdutos() {
      const alvo = document.getElementById("resumo-produtos");
      if (!alvo) return;
      alvo.innerHTML = "";

      const inputAss = document.getElementById("assessor-arvore");
      const codAss = inputAss ? inputAss.value : "";

      const dadosAss = filtrarDadosArvore(codAss, "");
      if (!dadosAss.length) {
        alvo.innerHTML = '<div class="col-12 text-muted small">Nenhum dado para este filtro.</div>';
        return;
      }

      const mapa = {};
      dadosAss.forEach(l => {
        const cat = l["Categoria"] || "Sem categoria";
        if (!mapa[cat]) mapa[cat] = { receita: 0, assessor: 0 };
        mapa[cat].receita += Number(l["Receita Bruta"] || 0);
        mapa[cat].assessor += Number(l["Valor Assessor"] || 0);
      });

      Object.entries(mapa).forEach(([categoria, vals]) => {
        const col = document.createElement("div");
        col.className = "col-md-3";
        col.innerHTML = `
          <div class="resumo-produto-card">
            <div class="titulo-produto">${categoria}</div>
            <small>Receita bruta</small><br>
            <strong>${formatBRL(vals.receita)}</strong><br><br>
            <small>Pago ao assessor</small><br>
            <strong>${formatBRL(vals.assessor)}</strong>
          </div>
        `;
        alvo.appendChild(col);
      });
    }

    function montarArvoreCategoria(dadosFiltrados) {
      const container = document.getElementById("arvore-container");

      if (!dadosFiltrados.length) {
        container.innerHTML = '<p class="text-muted small">Nenhum dado encontrado para este filtro.</p>';
        return;
      }

      let receitaBruta = 0;
      let comissaoEscritorio = 0;
      let valorImposto = 0;
      let escritorioPosImposto = 0;
      let valorAssessor = 0;

      const mapaCat = {};

      dadosFiltrados.forEach(l => {
        const receita = Number(l["Receita Bruta"] || 0);
        receitaBruta += receita;

        const comissao = (l["Comiss√£o Escrit√≥rio"] != null
          ? l["Comiss√£o Escrit√≥rio"]
          : l["Comiss√£o Escrit√≥rio Tratada"]) || 0;

        comissaoEscritorio += Number(comissao);
        valorImposto += Number(l["Valor Imposto"] || 0);
        escritorioPosImposto += Number(l["Sem Imposto"] || 0);
        valorAssessor += Number(l["Valor Assessor"] || 0);

        const catNome = l["Categoria"] || "Sem categoria";
        if (!mapaCat[catNome]) mapaCat[catNome] = 0;
        mapaCat[catNome] += receita;
      });

      if (!escritorioPosImposto && comissaoEscritorio) {
        escritorioPosImposto = comissaoEscritorio - valorImposto;
      }

      const xpParte = receitaBruta - comissaoEscritorio;
      const sobraEscritorio = escritorioPosImposto - valorAssessor;

      const listaCategoriasHTML = Object.entries(mapaCat)
        .sort((a, b) => b[1] - a[1])
        .map(([categoria, valor]) => `
          <div class="tree-prod-linha">
            <span class="prod-nome">${categoria}</span>
            <span class="prod-valor">${formatBRL(valor)}</span>
          </div>
        `).join("");

      const resumoTopHTML = `
        <div class="arvore-resumo-top">
          <div class="arvore-resumo-pill"><span class="label">Base</span><strong>${formatBRL(receitaBruta)}</strong></div>
          <div class="arvore-resumo-pill"><span class="label">XP</span><strong>${formatBRL(xpParte)}</strong></div>
          <div class="arvore-resumo-pill"><span class="label">Assessor</span><strong>${formatBRL(valorAssessor)}</strong></div>
          <div class="arvore-resumo-pill"><span class="label">Sobra Escrit√≥rio</span><strong>${formatBRL(sobraEscritorio)}</strong></div>
        </div>
      `;

      container.innerHTML = `
        ${resumoTopHTML}

        <div class="tree">
          <div>
            <div class="tree-level">
              <div class="tree-node node-produto">
                <div class="tree-pill">Categoria</div>
                <div class="tree-label">Receita bruta total</div>
                <div class="tree-value">${formatBRL(receitaBruta)}</div>

                ${listaCategoriasHTML ? `<div class="tree-sublist">${listaCategoriasHTML}</div>` : ""}
              </div>
            </div>

            <div class="tree-level">
              <div class="tree-connector">
                <div class="tree-node node-xp">
                  <div class="tree-pill">XP</div>
                  <div class="tree-label">Parte da XP</div>
                  <div class="tree-value">${formatBRL(xpParte)}</div>
                </div>
              </div>
              <div class="tree-connector">
                <div class="tree-node node-escritorio-bruto">
                  <div class="tree-pill">Escrit√≥rio</div>
                  <div class="tree-label">Comiss√£o escrit√≥rio (bruto)</div>
                  <div class="tree-value">${formatBRL(comissaoEscritorio)}</div>
                </div>
              </div>
            </div>

            <div class="tree-level">
              <div class="tree-connector">
                <div class="tree-node node-imposto">
                  <div class="tree-pill">Imposto</div>
                  <div class="tree-label">Imposto / despesa</div>
                  <div class="tree-value">${formatBRL(valorImposto)}</div>
                </div>
              </div>
              <div class="tree-connector">
                <div class="tree-node node-escritorio-pos">
                  <div class="tree-pill">Escrit√≥rio</div>
                  <div class="tree-label">Escrit√≥rio p√≥s imposto</div>
                  <div class="tree-value">${formatBRL(escritorioPosImposto)}</div>
                </div>
              </div>
            </div>

            <div class="tree-level">
              <div class="tree-connector">
                <div class="tree-node node-assessor">
                  <div class="tree-pill">Assessor</div>
                  <div class="tree-label">Pago ao assessor</div>
                  <div class="tree-value">${formatBRL(valorAssessor)}</div>
                </div>
              </div>
            </div>

      `;
    }

    function montarTabelaArvore(dadosFiltrados) {
      const wrapper = document.getElementById("tabela-arvore-wrapper");
      if (!wrapper) return;

      if (!dadosFiltrados || !dadosFiltrados.length) {
        wrapper.innerHTML = '<p class="text-muted small mb-0">Nenhuma linha para este filtro.</p>';
        return;
      }

      const todasColunas = Object.keys(dadosFiltrados[0]);
      const colunasPrincipais = COLUNAS_ORDENADAS.filter(c => todasColunas.includes(c));
      const colunasExtras = todasColunas.filter(c => !COLUNAS_ORDENADAS.includes(c));
      const colunas = [...colunasPrincipais, ...colunasExtras];

      let thead = "<thead><tr>" + colunas.map(c => `<th>${c}</th>`).join("") + "</tr></thead>";
      let tbody = "<tbody>" + dadosFiltrados.map(linha => {
        return "<tr>" + colunas.map(c => {
          const valor = (linha[c] === null || linha[c] === undefined) ? "" : linha[c];
          return `<td>${valor}</td>`;
        }).join("") + "</tr>";
      }).join("") + "</tbody>";

      wrapper.innerHTML = `
        <table class="table table-striped table-bordered table-sm">
          ${thead}
          ${tbody}
        </table>
      `;
    }

    function gerarTabelaHTML(linhas) {
      if (!linhas.length) return "";

      const todasColunas = Object.keys(linhas[0]);
      const colunasPrincipais = COLUNAS_ORDENADAS.filter(c => todasColunas.includes(c));
      const colunasExtras = todasColunas.filter(c => !COLUNAS_ORDENADAS.includes(c));
      const colunas = [...colunasPrincipais, ...colunasExtras];

      let thead = "<thead><tr>" + colunas.map(c => `<th>${c}</th>`).join("") + "</tr></thead>";
      let tbody = "<tbody>" + linhas.map(linha => {
        return "<tr>" + colunas.map(c => {
          const v = (linha[c] === null || linha[c] === undefined) ? "" : linha[c];
          return `<td>${v}</td>`;
        }).join("") + "</tr>";
      }).join("") + "</tbody>";

      return `
        <div class="table-responsive">
          <table class="table table-striped table-bordered table-sm">
            ${thead}
            ${tbody}
          </table>
        </div>
      `;
    }

    function montarTabelaHierarquica(dadosFiltrados) {
      const wrapper = document.getElementById("tabela-hierarquica-wrapper");
      if (!wrapper) return;

      if (!dadosFiltrados || !dadosFiltrados.length) {
        wrapper.innerHTML = '<p class="text-muted small mb-0">Nenhum dado para este filtro.</p>';
        return;
      }

      const agrupado = {};
      dadosFiltrados.forEach(linha => {
        const ass = linha["C√≥digo Assessor"] || "Sem c√≥digo";
        const cat = linha["Categoria"] || "Sem categoria";
        let prodRaw = linha["Produto"];

        if (prodRaw === null || prodRaw === undefined || String(prodRaw).trim() === "" || String(prodRaw).toLowerCase() === "nan") {
          prodRaw = "";
        }

        const temProdutoEspecifico = prodRaw !== "";
        const prod = temProdutoEspecifico ? prodRaw : "Sem produto";
        const valorAssessor = Number(linha["Valor Assessor"] || 0);

        if (!agrupado[ass]) agrupado[ass] = { totalAssessor: 0, categorias: {} };
        agrupado[ass].totalAssessor += valorAssessor;

        if (!agrupado[ass].categorias[cat]) {
          agrupado[ass].categorias[cat] = {
            totalCategoria: 0,
            produtos: {},
            linhasCategoria: [],
            temProdutoEspecifico: false
          };
        }

        const dadosCat = agrupado[ass].categorias[cat];
        dadosCat.totalCategoria += valorAssessor;
        dadosCat.linhasCategoria.push(linha);
        if (temProdutoEspecifico) dadosCat.temProdutoEspecifico = true;

        if (!dadosCat.produtos[prod]) dadosCat.produtos[prod] = { totalProduto: 0, linhas: [] };
        dadosCat.produtos[prod].totalProduto += valorAssessor;
        dadosCat.produtos[prod].linhas.push(linha);
      });

      const assessoresOrdenados = Object.keys(agrupado).sort((a, b) => a.localeCompare(b));
      let html = '<div class="accordion" id="accordionHierarquicoAssessor">';

      assessoresOrdenados.forEach((assessor, idxAss) => {
        const dadosAss = agrupado[assessor];
        const idCollapseAss = `collapseAss${idxAss}`;
        const idHeadingAss = `headingAss${idxAss}`;
        const idAccordionCategorias = `accordionAss${idxAss}Categorias`;

        html += `
          <div class="accordion-item">
            <h2 class="accordion-header" id="${idHeadingAss}">
              <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#${idCollapseAss}"
                aria-expanded="false" aria-controls="${idCollapseAss}">
                <div class="d-flex flex-column">
                  <span><strong>Assessor:</strong> ${assessor}</span>
                  <small class="text-muted">Total pago ao assessor: <strong>${formatBRL(dadosAss.totalAssessor)}</strong></small>
                </div>
              </button>
            </h2>

            <div id="${idCollapseAss}" class="accordion-collapse collapse"
              aria-labelledby="${idHeadingAss}"
              data-bs-parent="#accordionHierarquicoAssessor">

              <div class="accordion-body">
                <div class="accordion" id="${idAccordionCategorias}">
        `;

        const categoriasOrdenadas = Object.keys(dadosAss.categorias).sort((a, b) => a.localeCompare(b));
        categoriasOrdenadas.forEach((categoria, idxCat) => {
          const dadosCat = dadosAss.categorias[categoria];
          const idCollapseCat = `collapseCat${idxAss}_${idxCat}`;
          const idHeadingCat = `headingCat${idxAss}_${idxCat}`;
          const idAccordionProdutos = `accordionAss${idxAss}_Cat${idxCat}Prod`;

          html += `
            <div class="accordion-item">
              <h2 class="accordion-header" id="${idHeadingCat}">
                <button class="accordion-button collapsed" type="button"
                  data-bs-toggle="collapse" data-bs-target="#${idCollapseCat}"
                  aria-expanded="false" aria-controls="${idCollapseCat}">
                  <div class="d-flex flex-column">
                    <span><strong>Categoria:</strong> ${categoria}</span>
                    <small class="text-muted">Total pago nesta categoria: <strong>${formatBRL(dadosCat.totalCategoria)}</strong></small>
                  </div>
                </button>
              </h2>

              <div id="${idCollapseCat}" class="accordion-collapse collapse"
                aria-labelledby="${idHeadingCat}"
                data-bs-parent="#${idAccordionCategorias}">

                <div class="accordion-body">
          `;

          if (!dadosCat.temProdutoEspecifico) {
            const linhas = dadosCat.linhasCategoria;
            html += linhas.length ? gerarTabelaHTML(linhas) : `<p class="text-muted small">Sem opera√ß√µes nesta categoria.</p>`;
          } else {
            html += `<div class="accordion" id="${idAccordionProdutos}">`;

            const produtosOrdenados = Object.keys(dadosCat.produtos).filter(p => p !== "Sem produto").sort((a, b) => a.localeCompare(b));
            if (dadosCat.produtos["Sem produto"]) {
              produtosOrdenados.push("Outros");
              dadosCat.produtos["Outros"] = dadosCat.produtos["Sem produto"];
              delete dadosCat.produtos["Sem produto"];
            }

            produtosOrdenados.forEach((produto, idxProd) => {
              const dadosProd = dadosCat.produtos[produto];
              const idCollapseProd = `collapseProd${idxAss}_${idxCat}_${idxProd}`;
              const idHeadingProd = `headingProd${idxAss}_${idxCat}_${idxProd}`;

              html += `
                <div class="accordion-item">
                  <h2 class="accordion-header" id="${idHeadingProd}">
                    <button class="accordion-button collapsed" type="button"
                      data-bs-toggle="collapse" data-bs-target="#${idCollapseProd}"
                      aria-expanded="false" aria-controls="${idCollapseProd}">
                      <div class="d-flex flex-column">
                        <span><strong>Produto:</strong> ${produto}</span>
                        <small class="text-muted">Total pago neste produto: <strong>${formatBRL(dadosProd.totalProduto)}</strong></small>
                      </div>
                    </button>
                  </h2>

                  <div id="${idCollapseProd}" class="accordion-collapse collapse"
                    aria-labelledby="${idHeadingProd}"
                    data-bs-parent="#${idAccordionProdutos}">

                    <div class="accordion-body">
                      ${gerarTabelaHTML(dadosProd.linhas)}
                    </div>
                  </div>
                </div>
              `;
            });

            html += `</div>`;
          }

          html += `
                </div>
              </div>
            </div>
          `;
        });

        html += `
                </div>
              </div>
            </div>
          </div>
        `;
      });

      html += "</div>";
      wrapper.innerHTML = html;
    }

    function atualizarArvore() {
      const inputAss = document.getElementById("assessor-arvore");
      const inputCat = document.getElementById("produto-arvore");
      const textoFiltro = document.getElementById("texto-filtro-arvore");

      const codAss = inputAss ? inputAss.value : "";
      const categoria = inputCat ? inputCat.value : "";

      const filtrado = filtrarDadosArvore(codAss, categoria);
      dadosArvoreAtual = filtrado;

      montarArvoreCategoria(filtrado);
      montarTabelaArvore(filtrado);
      montarTabelaHierarquica(filtrado);
      montarGraficoCategoria(filtrado);
      montarGraficoProduto(filtrado);


      if (textoFiltro) {
        textoFiltro.textContent =
          "Assessor: " + (codAss ? codAss : "Todos") +
          "  |  Categoria: " + (categoria ? categoria : "Todos");
      }
    }
    function atualizarCategoriasPorAssessorAtual() {
  const inputAss = document.getElementById("assessor-arvore");
  const inputCat = document.getElementById("produto-arvore");
  if (!inputCat) return;

  const codAss = inputAss ? inputAss.value : "";
  listaCategoriasArvore = getCategoriasPorAssessor(codAss);

  // se a categoria atual n√£o existir para esse assessor, limpa
  if (inputCat.value) {
    const atual = inputCat.value.toLowerCase();
    const existe = listaCategoriasArvore.some(c => c.toLowerCase() === atual);
    if (!existe) inputCat.value = "";
  }
}


    function exportarTabelaArvoreCSV() {
      if (!dadosArvoreAtual || !dadosArvoreAtual.length) {
        alert("N√£o h√° dados filtrados para exportar.");
        return;
      }

      const todasColunas = Object.keys(dadosArvoreAtual[0]);
      const colunasPrincipais = COLUNAS_ORDENADAS.filter(c => todasColunas.includes(c));
      const colunasExtras = todasColunas.filter(c => !COLUNAS_ORDENADAS.includes(c));
      const colunas = [...colunasPrincipais, ...colunasExtras];

      const linhasCSV = [];
      linhasCSV.push(colunas.join(";"));

      dadosArvoreAtual.forEach(linha => {
        const campos = colunas.map(c => {
          let valor = linha[c];
          if (valor === null || valor === undefined) valor = "";
          valor = String(valor);
          if (valor.includes(";") || valor.includes('"')) valor = '"' + valor.replace(/"/g, '""') + '"';
          return valor;
        });
        linhasCSV.push(campos.join(";"));
      });

      const blob = new Blob([linhasCSV.join("\n")], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.href = url;
      link.download = "tabela_detalhada_arvore.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function limparFiltroArvore(tipo) {
      const inputAss = document.getElementById("assessor-arvore");
      const inputCat = document.getElementById("produto-arvore");
      const boxAss = document.getElementById("sugestoes-assessor-arvore");
      const boxCat = document.getElementById("sugestoes-produto-arvore");

      if (tipo === "assessor" && inputAss) inputAss.value = "";
      if (tipo === "categoria" && inputCat) inputCat.value = "";
      if (tipo === "todos") {
        if (inputAss) inputAss.value = "";
        if (inputCat) inputCat.value = "";
      }

      if (boxAss) boxAss.style.display = "none";
      if (boxCat) boxCat.style.display = "none";

      atualizarURLComFiltroArvore();
      atualizarArvore();
      montarResumoProdutos();
    }

    document.addEventListener("DOMContentLoaded", () => {

        // üîë INICIALIZA LISTAS E AUTOCOMPLETE
        carregarListasArvore();
        configurarAutocompleteArvore();

        // üîë L√ä O C√ìDIGO DA URL
        const url = new URL(window.location.href);
        const codParam = url.searchParams.get("cod");

        const inputAss = document.getElementById("assessor-arvore");
        if (inputAss && codParam && codParam !== "FeFePaFaHi") {
          inputAss.value = codParam;
        }

        // üîë ATUALIZA CATEGORIAS CONFORME ASSESSOR DA URL
        atualizarCategoriasPorAssessorAtual();

        // üîë MONTA TUDO
        montarResumoProdutos();
        atualizarArvore();

        // ===== BOT√ïES =====
        const btnExport = document.getElementById("btn-exportar-tabela-arvore");
        if (btnExport) btnExport.addEventListener("click", exportarTabelaArvoreCSV);

        const btnLimparAss = document.getElementById("btn-limpar-assessor-arvore");
        const btnLimparCat = document.getElementById("btn-limpar-categoria-arvore");
        if (btnLimparAss) btnLimparAss.addEventListener("click", () => limparFiltroArvore("assessor"));
        if (btnLimparCat) btnLimparCat.addEventListener("click", () => limparFiltroArvore("categoria"));

        const collapseResumo = document.getElementById("resumo-categoria-collapse");
        const iconeResumo = document.getElementById("icone-resumo-categoria");
        if (collapseResumo) {
          collapseResumo.addEventListener("show.bs.collapse", () => { iconeResumo.textContent = "‚ñæ"; });
          collapseResumo.addEventListener("hide.bs.collapse", () => { iconeResumo.textContent = "‚ñ∏"; });
        }
      });

  </script>

</body>
</html>
