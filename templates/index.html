<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Comiss√µes | Selecionar dashboard</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <style>
    body { background: #f5f7fb; }
    .card {
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    }
    .subtitle { color: #666; font-size: 0.9rem; }

    /* ===== Overlay de carregamento ===== */
    #loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      backdrop-filter: blur(2px);
    }
    .loading-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.12);
      padding: 18px 22px;
      display: flex;
      align-items: center;
      gap: 12px;
      border: 1px solid rgba(0,0,0,0.06);
    }
    .loading-text {
      font-weight: 600;
      color: #222;
    }
  </style>
</head>
<body>

  <!-- Overlay -->
  <div id="loading-overlay">
    <div class="loading-card">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <div class="loading-text">Carregando...</div>
    </div>
  </div>

  <div class="container py-5">
    <div class="row justify-content-center g-4">
      <div class="col-lg-10">

        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="alert alert-warning">
              {% for msg in messages %}
                <div>{{ msg }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <!-- T√çTULO PRINCIPAL -->
        <h1 class="text-center fw-bold mb-4">
          Comiss√µes Barsi Investimentos
        </h1>

        <div class="card p-4 p-md-5">
          <h1 class="h4 mb-2 text-center">Visualizar dashboards</h1>
          <p class="subtitle text-center mb-4">
            Selecione a compet√™ncia e a vers√£o do df_final j√° existente para abrir.
          </p>


        <!-- ===================== CARD √öNICO: VISUALIZAR DASHBOARDS EXISTENTES ===================== -->


          <form action="/visualizar" method="get" class="js-show-loading">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Compet√™ncia (m√™s/ano)</label>
                <select id="competencia-select" name="competencia" class="form-select" required>
                  <option value="">‚Äî Selecione ‚Äî</option>
                  {% for c in competencias_disponiveis %}
                    <option value="{{ c }}">{{ c }}</option>
                  {% endfor %}
                </select>
                <div class="form-text">Mostra as pastas YYYY-MM existentes no bucket.</div>
              </div>

              <div class="col-md-6">
                  <label class="form-label fw-semibold">Arquivo (vers√£o)</label>

                  <!-- guarda o path real do arquivo mais recente -->
                  <input type="hidden" id="arquivo-hidden" name="file" />

                  <!-- s√≥ mostra o nome escolhido automaticamente -->
                  <input type="text" id="arquivo-label" class="form-control" value="Selecione uma compet√™ncia primeiro" disabled>

                  <div class="form-text">Ser√° usada automaticamente a √∫ltima vers√£o do m√™s.</div>
                </div>

            </div>

            <button type="submit" class="btn btn-outline-dark w-100 mt-3">
              Abrir dashboard selecionado
            </button>
          </form>
        </div>

      </div>
    </div>
  </div>

  <script>
    // ===== Overlay helpers =====
    const overlay = document.getElementById("loading-overlay");
    function showLoading() { if (overlay) overlay.style.display = "flex"; }
    function hideLoading() { if (overlay) overlay.style.display = "none"; }
    window.addEventListener("pageshow", () => hideLoading());

    document.addEventListener("submit", (e) => {
      if (e.target && e.target.classList.contains("js-show-loading")) {
        showLoading();
      }
    });

    // ===================== Supabase file picker =====================

    const compSel = document.getElementById("competencia-select");
    const arqHidden = document.getElementById("arquivo-hidden");
    const arqLabel  = document.getElementById("arquivo-label");

    async function carregarUltimoArquivo(comp) {
      arqHidden.value = "";
      arqLabel.value = "Carregando...";

      if (!comp) {
        arqLabel.value = "Selecione uma compet√™ncia primeiro";
        return;
      }

      try {
        const res = await fetch(`/api/arquivos?competencia=${encodeURIComponent(comp)}`);
        const data = await res.json();

        if (!data.ok || !data.files || !data.files.length) {
          arqLabel.value = "Nenhum df_final encontrado";
          return;
        }

        // üîë sempre pega o mais novo
        const latestPath = data.files[0];
        arqHidden.value = latestPath;
        arqLabel.value = latestPath.split("/").pop();

      } catch (e) {
        arqLabel.value = "Erro ao buscar vers√£o";
      }
    }

    compSel?.addEventListener("change", (e) => {
      carregarUltimoArquivo(e.target.value);
    });

    document.addEventListener("DOMContentLoaded", () => {
      if (compSel?.value) carregarUltimoArquivo(compSel.value);
    });
</script>

</body>
</html>
